# Task configuration for OptimizationStrategist crew
# Sequential tasks: text optimization -> visual prompts -> compile plan -> generate images -> compile note
#
# Phase 0001 updates:
# - generate_text_optimizations: Added ContentIntent constraints and marketing check
# - generate_visual_prompts: Added VisualSubjects constraints
# - generate_images: New task for actual image generation
# - compile_optimized_note: New task to output final Note format

generate_text_optimizations:
  description: >
    基于动态生成的 optimization_context 生成**数据驱动**的文本内容优化方案。

    ## 核心原则
    **只优化需要优化的特征（见下方数据input中的*_features_to_optimize变量），不要过度优化。**

    ## Phase 0001: 内容一致性约束 (ContentIntent)
    **所有优化必须围绕原始笔记的内容创作意图，保持中心思想一致性：**
    - 核心主题 (core_theme): {content_intent_core_theme}
    - 目标人群 (target_persona): {content_intent_target_persona}
    - 关键信息 (key_message): {content_intent_key_message}
    - 独特角度 (unique_angle): {content_intent_unique_angle}
    - 情感基调 (emotional_tone): {content_intent_emotional_tone}

    **一致性检查清单**（输出前必须验证）：
    1. 标题是否传递 core_theme？
    2. 标题/开头是否吸引 target_persona？
    3. 内容是否突出 key_message？
    4. 整体语气是否符合 emotional_tone？

    ## Phase 0001: 营销感控制约束 (Marketing Sensitivity)
    营销敏感度: {marketing_sensitivity}
    当前营销标签: {marketing_level}
    是否已标记为软广: {is_soft_ad}

    **营销感控制规则**:
    - 如果 marketing_sensitivity = "high"（已被标记为软广）：
      * ❌ 禁止使用硬广词汇：购买、下单、链接、优惠券
      * ❌ 禁止使用夸张用语：最好、必买、绝绝子、yyds
      * ❌ 禁止使用强CTA：快去买、冲冲冲、姐妹们快
      * ✅ 使用真实体验分享语气
      * ✅ 使用客观描述而非推销语气
    - 如果 marketing_sensitivity = "medium"：
      * ⚠️ 注意减少推荐性词汇
      * ✅ 增加个人真实感受描述
    - 如果 marketing_sensitivity = "low"：
      * ✅ 正常优化，无特殊限制

    ## 任务目标
    根据输入数据中的 *_features_to_optimize 变量，确定需要优化的文本区域：

    1. **识别需要优化的区域**：
       - 如果 title_features_to_optimize 非空 → 优化标题
       - 如果 opening_features_to_optimize 非空 → 优化开头钩子
       - 如果 body_features_to_optimize 非空 → 优化正文
       - 如果 ending_features_to_optimize 非空 → 优化结尾CTA
       - 如果 hashtags_features_to_optimize 非空 → 优化话题标签
       - 如果某区域的变量为空，说明该区域无需优化

    2. **优化方式**：
       - 参考 current_* 变量了解当前特征
       - 针对 *_features_to_optimize 中列出的弱点进行改进
       - 优化后的内容应该提升 priority_metrics_list 中的指标

    ## 输出格式
    返回JSON对象，**只包含需要优化的部分**：
    ```json
    {
      "title_alternatives": [...],      // 3个备选，仅当 title_features_to_optimize 非空时
      "opening_hook": {...},            // 仅当 opening_features_to_optimize 非空时
      "body_optimizations": [...],      // 仅当 body_features_to_optimize 非空时
      "ending_cta": {...},              // 仅当 ending_features_to_optimize 非空时
      "hashtags": {...},                // 仅当 hashtags_features_to_optimize 非空时
      "optimization_summary": "..."     // 说明哪些部分需要/不需要优化及原因
    }
    ```

    **IMPORTANT - 输出格式约束**：

    每个优化项必须包含：
    - original: string（从数据input的original_title或original_content中提取的原始文本）
    - optimized: string（优化后的文本内容）
    - rationale: string（优化理由，说明针对哪些弱特征进行了改进）
    - targeted_metrics: list[string]（**必须从priority_metrics_list中选择**）
    - targeted_weak_features: list[string]（从对应的*_features_to_optimize变量中选择）

    **CRITICAL约束**：
    1. **title_alternatives的original**：必须使用完整的original_title，不是keyword
    2. **hashtags的original**：必须从original_content提取**完整的所有话题标签**（通常在内容末尾），不要遗漏任何标签
    3. **hashtags格式**：original和optimized都是完整的string（如"#话题1[话题]# #话题2[话题]#"），不是list或dict
    4. **targeted_metrics**：只能包含priority_metrics_list中的指标，不要预测其他指标

    **数据input**：
    - keyword (SEO目标关键词): {keyword}
    - original_title (原始标题): {original_title}
    - original_content (原始正文完整内容): {original_content}
    - priority_metrics_list (需要提升的指标): {priority_metrics_list}
    - title_features_to_optimize (标题需优化的特征): {title_features_to_optimize}
    - opening_features_to_optimize (开头需优化的特征): {opening_features_to_optimize}
    - body_features_to_optimize (正文需优化的特征): {body_features_to_optimize}
    - ending_features_to_optimize (结尾需优化的特征): {ending_features_to_optimize}
    - hashtags_features_to_optimize (话题标签需优化的特征): {hashtags_features_to_optimize}
    - current_title_pattern (当前标题套路): {current_title_pattern}
    - current_title_emotion (当前标题情感强度): {current_title_emotion}
    - current_opening_hook (当前开头钩子类型): {current_opening_hook}
    - current_ending_cta (当前结尾召唤行动类型): {current_ending_cta}
    - current_content_framework (当前内容框架): {current_content_framework}

  expected_output: >
    JSON格式的数据驱动优化方案。只优化optimization_context中列出的特征，
    不要过度优化。包含optimization_summary说明决策依据。
  agent: optimization_strategist


generate_visual_prompts:
  description: >
    基于 optimization_context 生成**数据驱动**的视觉优化方案。

    ## Phase 0001: 视觉主体一致性约束 (VisualSubjects)
    **所有视觉优化必须保持与原始笔记视觉主体的一致性：**
    - 主体类型 (subject_type): {visual_subject_type}
    - 主体描述 (subject_description): {visual_subject_description}
    - 品牌元素 (brand_elements): {visual_brand_elements}
    - 必须保留的元素 (must_preserve): {visual_must_preserve}
    - 原始封面图URL: {original_cover_url}
    - 原始内页图URLs: {original_inner_urls}

    **视觉一致性规则**：
    1. 如果 subject_type = "product"：
       - prompt 必须包含产品外观描述
       - 产品在画面中的位置和比例需保持一致
    2. 如果 subject_type = "person"：
       - prompt 需描述人物特征（但不要具体面部细节）
       - 保持人物出镜风格一致
    3. 如果有 brand_elements：
       - prompt 需提及品牌元素的保留需求
       - logo/配色/包装等元素需在生成图片中体现
    4. must_preserve 中的所有元素都必须在 prompt 中明确提及

    **IMPORTANT - 引用图片约束**：
    - 在生成图片时，请使用原始图片URL作为参考
    - 这样可以帮助保持视觉风格一致性

    ## 任务目标
    根据数据input中的 need_visual_optimization 判断是否需要生成视觉优化方案：

    **如果 need_visual_optimization = True**：
    - visual_features_to_optimize 列出了需要优化的视觉特征
    - 参考 current_* 变量了解当前视觉特征
    - 生成以下AIGC prompts：
      1. 封面图优化prompt（cover_prompt，VisualPrompt对象）
      2. 内页图优化prompts（inner_image_prompts，0-3个VisualPrompt对象）
      3. 通用视觉建议（general_visual_guidelines）
    - skip_reason 如果没有优化需要，则设为 null

    **如果 need_visual_optimization = False**：
    - 视觉特征表现良好，无需优化
    - 返回：
      - cover_prompt: null
      - inner_image_prompts: []
      - general_visual_guidelines: ["当前封面图吸引力、配色方案、视觉风格等指标表现良好，建议保持现有方案"]
      - skip_reason: "当前封面图吸引力、配色方案、视觉风格等视觉特征表现良好，无需优化"

    ## 输出格式
    返回JSON对象：
    ```json
    {
      "cover_prompt": {...},              // need_visual_optimization=True时必填
      "inner_image_prompts": [...],       // 可选，0-3个
      "general_visual_guidelines": [...], // 必填
      "visual_optimization_summary": "..." // 说明决策依据
    }
    ```

    **IMPORTANT - VisualPrompt格式约束**：

    每个VisualPrompt对象必须包含：
    - image_type: string（必须是 "cover" 或 "inner_1", "inner_2" 等，不能是中文）
    - prompt_text: string（AIGC提示词，**至少50字符**，详细描述画面内容、氛围、构图、光线等）
    - style_reference: string（风格参考，至少10字符）
    - key_elements: list[string]（关键元素列表，2-6个）
    - color_scheme: string（色彩方案，**必须是string**，至少10字符）
    - targeted_metrics: list[string]（从priority_metrics_list中选择）

    **封面图格式示例**：
    ```json
    {
      "image_type": "cover",
      "prompt_text": "一位年轻妈妈温柔地看着宝宝，手中拿着DHA营养品。背景是温馨的家居环境，光线柔和。画面传递出母爱和健康成长的氛围。",
      "style_reference": "小红书爆款育儿笔记风格，真实生活感",
      "key_elements": ["年轻妈妈", "宝宝", "DHA产品", "温馨家居"],
      "color_scheme": "暖色调，柔和的黄色和白色为主，绿色点缀代表健康",
      "targeted_metrics": ["ctr", "sort_score2"]
    }
    ```

    **数据input**：
    - keyword (SEO目标关键词): {keyword}
    - priority_metrics_list (需要提升的指标): {priority_metrics_list}
    - need_visual_optimization (是否需要视觉优化): {need_visual_optimization}
    - visual_features_to_optimize (视觉需优化的特征): {visual_features_to_optimize}
    - current_thumbnail_appeal (当前封面图吸引力): {current_thumbnail_appeal}
    - current_color_scheme (当前配色方案): {current_color_scheme}
    - current_visual_tone (当前视觉风格): {current_visual_tone}

  expected_output: >
    JSON格式的数据驱动视觉优化方案。只优化optimization_context中的视觉特征，
    包含visual_optimization_summary说明决策依据。
  agent: optimization_strategist


compile_optimization_plan:
  description: >
    汇总前两个任务的输出，生成完整的优化方案(OptimizationPlan)。

    ## 任务目标
    1. **整合优化结果**：
       - 从 text_optimizations（前一个任务的输出）中提取文本优化内容
       - 从 visual_prompts（前一个任务的输出）中提取视觉优化内容
       - 如果某部分有优化内容 → 填入对应字段
       - 如果某部分无需优化 → 填入占位结构或保留原内容

    2. **生成优先执行建议(priority_summary)**：
       - 基于 priority_metrics_list 中的指标
       - 说明应该先执行哪些优化，为什么
       - 如果某些部分无需优化，也要说明原因

    3. **生成预期影响(expected_impact)** - CRITICAL约束：
       - **ONLY预测 priority_metrics_list 中的指标**（共 {priority_metrics_count} 个）
       - **这是完整列表，必须全部预测，不多不少**
       - **NEVER预测不存在的指标**: save_count, read_completion, engagement_rate, comment_count, search_visibility
       - 这些指标在prediction模型中未定义，预测它们是幻觉行为
       - 格式：{{"metric1": "预期效果描述", "metric2": "预期效果描述", ...}}
       - **验证清单**（输出前必须检查）：
         1. expected_impact 的 keys 数量 = {priority_metrics_count}
         2. expected_impact 的每个 key 都在 {priority_metrics_list} 中
         3. {priority_metrics_list} 中的每个指标都在 expected_impact 中

    ## 输出格式
    返回完整的OptimizationPlan JSON对象：
    - keyword: 关键词（从数据input获取）
    - owned_note_id: 笔记ID（从数据input获取）
    - title_optimization: 标题优化方案
      - 如有优化：包含 alternatives(1-3个)、recommended_index、selection_rationale
      - 如无需优化：alternatives 保留原标题，rationale 说明"当前标题已符合要求"
    - content_optimization: 内容优化方案（各字段根据实际需求填充或留空）
    - visual_optimization: 视觉优化方案
      - 如无需优化：cover_prompt 为 null，general_visual_guidelines 说明原因
    - priority_summary: 优先执行建议（包含需要/不需要优化的说明）
    - expected_impact: 预期影响字典（只包含 priority_metrics_list 中的指标）
    - plan_timestamp: ISO 8601 格式时间戳

    **数据input**：
    - text_optimizations (来自Task 1的输出，CrewAI自动传递): generate_text_optimizations任务的JSON输出
    - visual_prompts (来自Task 2的输出，CrewAI自动传递): generate_visual_prompts任务的JSON输出
    - keyword (SEO目标关键词): {keyword}
    - note_id (笔记ID): {note_id}
    - priority_metrics_list (需要预测的指标列表): {priority_metrics_list}
    - priority_metrics_count (指标数量): {priority_metrics_count}
    - original_title (用于无需优化时的占位): {original_title}

  expected_output: >
    完整的OptimizationPlan JSON对象，符合Pydantic模型定义。
    保持完整结构，对无需优化的部分用占位值或说明。
  agent: optimization_strategist


# ============================================================================
# Phase 0001: 新增任务 - 图像生成
# ============================================================================
generate_images:
  description: >
    使用 ImageGeneratorTool 根据优化方案中的视觉 prompts 生成实际图片。

    ## 任务目标
    基于前一任务 (compile_optimization_plan) 输出的 OptimizationPlan，
    调用 ImageGeneratorTool 生成封面图和内页图。

    ## 输入数据
    - optimization_plan: 前一任务输出的 OptimizationPlan JSON
    - visual_subjects: 视觉主体信息
      - subject_type: {visual_subject_type}
      - must_preserve: {visual_must_preserve}
      - original_cover_url: {original_cover_url}
      - original_inner_urls: {original_inner_urls}
    - need_visual_optimization: {need_visual_optimization}

    ## 执行步骤

    **如果 need_visual_optimization = False**：
    - 跳过图片生成
    - 返回使用原始图片的结果：
      ```json
      {
        "images_generated": false,
        "skip_reason": "视觉特征无需优化，保留原始图片",
        "cover_image": {
          "image_type": "cover",
          "success": true,
          "image_url": "{original_cover_url}",
          "local_path": null,
          "error": null,
          "prompt_used": "保留原图",
          "reference_image_used": null
        },
        "inner_images": []
      }
      ```

    **如果 need_visual_optimization = True**：
    1. **生成封面图**：
       - 从 optimization_plan.visual_optimization.cover_prompt 提取 prompt
       - 调用 ImageGeneratorTool:
         * prompt: cover_prompt.prompt_text
         * reference_image_url: {original_cover_url}（用于保持风格一致）
         * must_preserve_elements: {visual_must_preserve}
         * style_reference: cover_prompt.style_reference
         * image_type: "cover"
       - 记录生成结果（成功则有 image_url，失败则有 error）

    2. **生成内页图**（如果有）：
       - 从 optimization_plan.visual_optimization.inner_image_prompts 提取 prompts
       - 对每个 prompt 调用 ImageGeneratorTool
       - 使用对应的 original_inner_urls 作为参考
       - 记录每个图片的生成结果

    3. **汇总结果**：
       - 统计成功/失败数量
       - 对于失败的图片，记录错误信息和建议使用原图

    ## 输出格式
    返回 JSON 对象：
    ```json
    {
      "images_generated": true,
      "cover_image": {
        "image_type": "cover",
        "success": true/false,
        "image_url": "生成的图片URL（成功时）",
        "local_path": "本地保存路径（成功时）",
        "error": "错误信息（失败时）",
        "prompt_used": "使用的prompt",
        "reference_image_used": "参考图片URL"
      },
      "inner_images": [
        {
          "image_type": "inner_1",
          "success": true/false,
          "image_url": "...",
          "local_path": "...",
          "error": "...",
          "prompt_used": "...",
          "reference_image_used": "..."
        }
      ],
      "generation_summary": "生成结果摘要：成功N张，失败M张"
    }
    ```

    ## 错误处理
    - 如果封面图生成失败：记录错误，建议使用原图 {original_cover_url}
    - 如果内页图生成失败：记录错误，建议使用对应的原图
    - 所有图片都失败时：返回完整错误信息，保留原图URLs

  expected_output: >
    JSON格式的图片生成结果，包含cover_image和inner_images。
    每个图片记录success状态、URL/路径或错误信息。
  agent: image_generator


# ============================================================================
# Phase 0001: 新增任务 - 编译最终优化笔记
# ============================================================================
compile_optimized_note:
  description: >
    汇总所有优化结果，生成最终的 OptimizedNote 对象。

    ## 任务目标
    将文本优化、视觉优化、图片生成的结果整合为符合 Note 格式的最终输出。

    ## 输入数据
    - 笔记基础信息:
      - note_id: {note_id}
      - keyword: {keyword}
      - original_title: {original_title}
      - original_content: {original_content}
    - content_intent (内容创作意图):
      - core_theme: {content_intent_core_theme}
      - target_persona: {content_intent_target_persona}
      - key_message: {content_intent_key_message}
      - unique_angle: {content_intent_unique_angle}
      - emotional_tone: {content_intent_emotional_tone}
    - 营销相关:
      - marketing_sensitivity: {marketing_sensitivity}
      - marketing_level: {marketing_level}
      - is_soft_ad: {is_soft_ad}
    - 原始图片URLs:
      - original_cover_url: {original_cover_url}
      - original_inner_urls: {original_inner_urls}
    - 来自前序任务的结果:
      - text_optimizations: generate_text_optimizations 任务输出
      - optimization_plan: compile_optimization_plan 任务输出
      - generated_images: generate_images 任务输出

    ## 执行步骤

    1. **选择最终标题**：
       - 从 optimization_plan.title_optimization.alternatives 中选择
       - 优先使用 recommended_index 指定的标题
       - 如果无标题优化，使用 original_title

    2. **整合最终正文**：
       - 从 text_optimizations 中提取 opening_hook.optimized（如有）
       - 从 text_optimizations 中提取 body_optimizations（如有）
       - 从 text_optimizations 中提取 ending_cta.optimized（如有）
       - 从 text_optimizations 中提取 hashtags.optimized（如有）
       - 将各部分整合为完整正文
       - 如无优化，使用 original_content

    3. **确定最终图片**：
       - 检查 generated_images.cover_image.success
         * 如果成功：使用 generated_images.cover_image.image_url
         * 如果失败或未生成：使用 original_cover_url
       - 检查 generated_images.inner_images
         * 成功的使用生成的 URL
         * 失败的使用 original_inner_urls 中对应的 URL
       - 记录 cover_image_source 和 inner_images_source

    4. **构建 ContentIntent 对象**：
       - 使用输入的 content_intent_* 变量构建

    5. **进行营销感检查（可选）**：
       - 如果 marketing_sensitivity = "high"：
         * 对比优化前后的营销感评分
         * 记录检查结果
       - 否则：marketing_check = null

    6. **生成优化摘要**：
       - 列出哪些部分被优化了
       - 说明主要改动和预期效果

    ## 输出格式
    返回符合 OptimizedNote schema 的 JSON 对象：
    ```json
    {
      "note_id": "optimized_{original_note_id}",
      "original_note_id": "{note_id}",
      "keyword": "{keyword}",
      "title": "选定的优化后标题",
      "content": "整合后的完整正文内容",
      "cover_image_url": "最终封面图URL",
      "inner_image_urls": ["最终内页图URL1", "..."],
      "prediction": null,
      "tag": null,
      "content_intent": {
        "core_theme": "...",
        "target_persona": "...",
        "key_message": "...",
        "unique_angle": "...",
        "emotional_tone": "..."
      },
      "marketing_check": null 或 {
        "original_score": 0.X,
        "optimized_score": 0.X,
        "level": "low/medium/high/critical",
        "passed": true/false,
        "issues": [],
        "suggestions": []
      },
      "optimization_summary": "优化摘要：标题采用情感化改写，开头增加痛点钩子，封面图重新生成以提升吸引力...",
      "cover_image_source": "generated/original",
      "inner_images_source": "generated/original/mixed",
      "optimized_timestamp": "ISO 8601 格式时间戳"
    }
    ```

    ## 验证要点
    - title 不能为空
    - content 不能为空
    - cover_image_url 必须是有效URL或原图URL
    - content_intent 必须完整
    - optimized_timestamp 使用当前时间

  expected_output: >
    完整的 OptimizedNote JSON 对象，符合 Note 格式要求。
    包含优化后的 title、content、图片URLs，以及 content_intent 和 optimization_summary。
  agent: optimization_strategist
