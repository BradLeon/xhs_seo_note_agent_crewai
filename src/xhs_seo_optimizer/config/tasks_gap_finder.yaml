# Task Configuration for Gap Finder Crew
# 差距定位员 Crew 的任务配置
#
# 2 sequential tasks: calculate gaps (Tool) → generate report (LLM reasoning)

calculate_statistical_gaps:
  description: |
    使用StatisticalDeltaTool计算客户笔记与竞品笔记的统计差距。

    **工具调用方式（Smart Mode）**:
    直接调用 statistical_delta_analysis()，无需传递任何参数。
    工具会自动从系统context中读取audit_report和success_profile_report。

    工具会自动执行以下计算：
    1. 对每个指标计算统计差距（z_score, p_value, significance）
    2. 按显著性分类: significant (p<0.05), marginal (0.05<=p<0.10), non_significant (p>=0.10)
    3. 计算优先级分数并排序
    4. 自动从attribution.py获取每个指标的related_features和rationale

    **执行步骤**:
    1. 调用 statistical_delta_analysis() 一次
    2. 工具会直接返回 GapAnalysis JSON

    **重要：输出格式要求**:
    - 调用工具后，直接将工具返回的 JSON 作为你的输出
    - ❌ 不要添加 "Final Answer:" 前缀
    - ❌ 不要重复输出 JSON（只输出一次）
    - ❌ 不要添加任何解释或评论
    - ✅ 直接输出工具返回的纯 JSON（以 { 开头，以 } 结尾）
  expected_output: |
    GapAnalysis JSON，必须包含以下字段：
    - significant_gaps: List[UnifiedGap] - 显著差距 (p < 0.05)
    - marginal_gaps: List[UnifiedGap] - 边缘显著差距 (0.05 <= p < 0.10)
    - non_significant_gaps: List[UnifiedGap] - 非显著差距 (p >= 0.10)
    - priority_order: List[str] - 按优先级排序的指标名称
    - sample_size: int - 竞品笔记样本量

    每个UnifiedGap对象必须包含（Task 1 填充的核心统计字段）：
    - metric: str - 指标名称
    - owned_value: float - 客户笔记的值 (可选)
    - target_mean: float - 目标笔记均值
    - target_std: float - 目标笔记标准差
    - delta_absolute: float - 绝对差值
    - delta_pct: float - 百分比差值
    - z_score: float - Z分数
    - p_value: float - P值 (0.0-1.0)
    - significance: str - 显著性级别 (critical|very_significant|significant|marginal|none|undefined)
    - interpretation: str - 人类可读的解释
    - related_features: List[str] - 影响该指标的相关特征（来自attribution.py）
    - rationale: str - 特征归因理由
  agent: gap_finder

generate_gap_report:
  description: |
    基于Task 1的统计差距分析，完成特征映射、优先级排序、根因分析，生成最终GapReport。

    **输入数据**:
    - Task 1 输出: GapAnalysis (significant_gaps, marginal_gaps, non_significant_gaps, priority_order)
    - success_profile_report: 包含metric_profiles (每个指标的成功模式和相关特征)
    - audit_report: 包含text_features, visual_features (客户笔记的实际特征)
    - keyword: {keyword}
    - note_id: {note_id} (自有笔记ID，用于owned_note_id字段)

    **任务内容（按顺序完成）**:

    ## 第一步：特征映射 (Feature Mapping)

    对于每个 significant_gap、marginal_gap 和 non_significant_gap:

    1. 获取gap的related_features列表
    2. 逐一检查audit_report中对应特征的实际值，判断是"缺失"还是"执行不足":

    **如何判断 missing_features（缺失的特征）**:
    - audit_report中该特征字段为 null、空字符串、空数组
    - 例如: pain_points=[], ending_cta=null, social_proof=[]

    **如何判断 weak_features（执行不足的特征）**:
    - 特征存在但质量不高或不够突出
    - 文本特征: 内容过于简单、缺乏情感、没有具体数据支撑
    - 视觉特征: 评估词为"一般"、"普通"、"不突出"等
    - 例如: title_emotion="中性" (应该更有感染力)
    - 例如: opening_hook="直接陈述" (应该更有冲击力)
    - 例如: thumbnail_appeal="一般" (应该更吸引眼球)

    **特征映射示例**:
    假设 related_features=["title_emotion", "opening_hook", "pain_points"]
    audit_report.text_features:
      - title_emotion: "中性、平淡" → weak_features.append("title_emotion")
      - opening_hook: "故事型钩子" → OK, 不加入
      - pain_points: [] → missing_features.append("pain_points")
    结果: missing_features=["pain_points"], weak_features=["title_emotion"]

    3. 基于识别出的missing/weak特征，生成:
       - gap_explanation: 具体解释为什么差距存在，关联到具体特征 (50-200字符)
       - recommendation_summary: 针对性改进建议 (20-100字符)

    ## 第二步：优先级排序 (Prioritization)
    1. 使用Task 1的priority_order为每个gap分配priority_rank (1-based)
    2. 识别 top_priority_metrics: 选择top 3最重要的指标
    3. 识别 root_causes: 汇总所有gaps的missing_features和weak_features，找出出现频率最高的3-5个
       - 用中文描述 (如: "标题情感不够强烈", "缺少痛点挖掘", "封面视觉冲击力不足")
    4. 生成 impact_summary: 整体差距叙述 (50-500字符)

    ## 第三步：输出格式化
    1. 整合所有分析结果到GapReport模型
    2. 添加metadata: keyword={keyword}, owned_note_id={note_id}, sample_size, gap_timestamp
    3. 输出为JSON格式

    **输出格式要求（严格执行）**:
    - ⚠️ 第一个字符必须是 `{`，最后一个字符必须是 `}`
    - ⚠️ 不要有任何前置文字
    - ⚠️ 只输出一个 JSON 对象
    - ✅ 直接输出纯 JSON 对象

  expected_output: |
    ⚠️ 严格要求：直接输出纯JSON，第一个字符必须是 `{`，不要有任何思考过程、解释或markdown代码块！

    GapReport JSON，必须包含以下字段：

    顶层字段：
    - keyword: str - 目标关键词
    - owned_note_id: str - 自有笔记ID (使用输入参数 note_id 的值: {note_id})
    - significant_gaps: List[UnifiedGap] - 显著差距 (p < 0.05)
    - marginal_gaps: List[UnifiedGap] - 边缘显著差距 (0.05 <= p < 0.10)
    - non_significant_gaps: List[UnifiedGap] - 非显著差距
    - top_priority_metrics: List[str] - 最多3个重点指标
    - root_causes: List[str] - 3-5个根本原因
    - impact_summary: str - 整体影响总结 (50-500字符)
    - sample_size: int - 竞品笔记样本量
    - gap_timestamp: str - ISO 8601时间戳

    每个UnifiedGap对象必须包含：
    - metric: str - 指标名称 (注意：使用 metric 而不是 metric_name)
    - owned_value: float - 客户笔记的值
    - target_mean: float - 目标笔记均值
    - target_std: float - 目标笔记标准差
    - delta_absolute: float - 绝对差值
    - delta_pct: float - 百分比差值
    - z_score: float - Z分数
    - p_value: float - P值 (0.0-1.0)
    - significance: str - 显著性级别 (critical|very_significant|significant|marginal|none)
    - interpretation: str - 人类可读的解释
    - related_features: List[str] - 影响该指标的相关特征
    - rationale: str - 特征归因理由
    - missing_features: List[str] - 缺失的关键特征 (本任务填充)
    - weak_features: List[str] - 执行不足的特征 (本任务填充)
    - gap_explanation: str - 差距原因解释 (50-200字符)
    - recommendation_summary: str - 改进建议 (20-100字符)
    - priority_rank: int - 优先级排名 (1-based)
  agent: gap_finder
  output_file: outputs/gap_report.json
