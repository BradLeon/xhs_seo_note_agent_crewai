# Task Configuration for Gap Finder Crew
# 差距定位员 Crew 的任务配置
#
# 4 sequential tasks: calculate gaps → map to features → prioritize → generate report

calculate_statistical_gaps:
  description: |
    使用StatisticalDeltaTool计算客户笔记与竞品笔记的统计差距。

    **工具调用方式（Smart Mode）**:
    直接调用 statistical_delta_analysis()，无需传递任何参数。
    工具会自动从系统context中读取audit_report和success_profile_report。

    工具会自动执行以下计算：
    1. 对每个指标计算统计差距：
       - z_score = (owned_value - target_mean) / target_std
       - p_value = 2 * (1 - norm.cdf(abs(z_score)))  # 双尾检验
       - significance: critical (p<0.001), very_significant (p<0.01), significant (p<0.05), marginal (p<0.10), none

    2. 按显著性分类: significant (p<0.05), marginal (0.05<=p<0.10), non_significant (p>=0.10)

    3. 计算优先级分数: priority_score = |z_score| * |delta_pct| / 100

    4. 自动从attribution.py获取每个指标的related_features和rationale

    **执行步骤**:
    1. 调用 statistical_delta_analysis()
    2. 解析返回的GapAnalysis JSON结果

    输出：GapAnalysis结果，包含significant_gaps, marginal_gaps, non_significant_gaps, priority_order
  expected_output: |
    GapAnalysis JSON，必须包含以下字段：
    - significant_gaps: List[Gap] - 显著差距 (p < 0.05)
    - marginal_gaps: List[Gap] - 边缘显著差距 (0.05 <= p < 0.10)
    - non_significant_gaps: List[Gap] - 非显著差距 (p >= 0.10)
    - priority_order: List[str] - 按优先级排序的指标名称
    - sample_size: int - 竞品笔记样本量

    每个Gap对象必须包含：
    - metric: str - 指标名称
    - owned_value: float - 客户笔记的值
    - target_mean: float - 目标笔记均值
    - target_std: float - 目标笔记标准差
    - delta_absolute: float - 绝对差值
    - delta_pct: float - 百分比差值
    - z_score: float - Z分数
    - p_value: float - P值 (0.0-1.0)
    - significance: str - 显著性级别 (critical|very_significant|significant|marginal|none|undefined)
    - interpretation: str - 人类可读的解释
    - related_features: List[str] - 影响该指标的相关特征（来自attribution.py）
    - rationale: str - 特征归因理由
  agent: gap_finder

map_gaps_to_features:
  description: |
    将指标差距映射到具体的内容特征缺失或执行不足。

    输入数据 (from context):
    - Task 1 输出: 统计差距分析 (significant_gaps list)，每个gap已包含related_features和rationale
    - success_profile_report: 包含metric_profiles (每个指标的成功模式和相关特征)
    - audit_report: 包含text_features和visual_features (客户笔记的实际特征)

    任务：
    对于每个significant gap:
    1. 使用gap中已有的related_features列表（来自Task 1的StatisticalDeltaTool输出）
    2. 比对audit_report的text_features/visual_features，识别：
       - missing_features: related_features中客户笔记缺失的特征
       - weak_features: 客户笔记中存在但执行不足的特征 (基于feature strength/score)
    3. 结合gap.rationale，生成gap_explanation: 解释为什么这个指标差距存在 (2-3句话，基于特征对比)
    4. 生成recommendation_summary: 简要建议如何改进 (1-2句话)

    注意：特征归因信息(related_features和rationale)已由Task 1的StatisticalDeltaTool自动填充，
    无需手动查找或硬编码。直接使用gap对象中的这些字段即可。

    输出：为每个significant gap添加feature attribution和narrative
  expected_output: |
    FeatureMappedGapAnalysis JSON，必须包含以下字段：
    - significant_gaps: List[FeatureMappedGap] - 显著差距，已包含特征映射
    - marginal_gaps: List[FeatureMappedGap] - 边缘显著差距
    - non_significant_gaps: List[FeatureMappedGap] - 非显著差距
    - priority_order: List[str] - 按优先级排序的指标名称
    - sample_size: int - 竞品笔记样本量

    每个FeatureMappedGap对象必须包含Task 1的所有字段，加上：
    - missing_features: List[str] - 客户笔记中缺失的关键特征
    - weak_features: List[str] - 客户笔记中执行不足的特征
    - gap_explanation: str - 差距原因解释 (50-200字符，2-3句话)
    - recommendation_summary: str - 改进建议 (20-100字符，1-2句话)

    字段长度约束：
    - gap_explanation: 50-200字符
    - recommendation_summary: 20-100字符
  agent: gap_finder
  context: [calculate_statistical_gaps]

prioritize_gaps:
  description: |
    对差距进行优先级排序，并识别跨指标的根本原因。

    输入数据 (from context):
    - Task 1: priority_order (按统计显著性和影响magnitude排序)
    - Task 2: feature-mapped gaps (包含missing_features和weak_features)

    任务：
    1. 使用Task 1的priority_order为每个gap分配priority_rank (1-based)
    2. 识别top_priority_metrics: 选择top 3最重要的指标
    3. 识别root_causes: 跨多个指标的共同原因
       - 方法: 统计missing_features和weak_features的频率
       - 选择出现频率最高的3-5个作为root causes
       - 用中文描述 (如: "标题缺乏情感钩子", "封面视觉冲击力不足")
    4. 生成impact_summary: 整体差距叙述 (50-500字符)
       - 说明主要问题和整体影响
       - 突出最严重的2-3个gap
       - 指出改进方向
  expected_output: |
    PrioritizedGapAnalysis JSON，必须包含以下字段：
    - significant_gaps: List[FeatureMappedGap] - 显著差距（继承自Task 2）
    - marginal_gaps: List[FeatureMappedGap] - 边缘显著差距
    - non_significant_gaps: List[FeatureMappedGap] - 非显著差距
    - top_priority_metrics: List[str] - 前3个需要重点改进的指标（最多3个）
    - root_causes: List[str] - 3-5个跨指标的根本原因
    - impact_summary: str - 整体差距总结 (50-500字符)
    - priority_order: List[str] - 按优先级排序的指标名称
    - sample_size: int - 竞品笔记样本量

    字段约束：
    - top_priority_metrics: 最多3个
    - root_causes: 3-5个
    - impact_summary: 50-500字符，说明主要问题和整体影响，突出最严重的2-3个gap，指出改进方向
  agent: gap_finder
  context: [calculate_statistical_gaps, map_gaps_to_features]

generate_gap_report:
  description: |
    生成最终的GapReport JSON输出。

    输入数据 (from all previous tasks):
    - Task 1: 统计差距分类 (significant_gaps, marginal_gaps, non_significant_gaps)
    - Task 2: 特征映射后的gap详细信息
    - Task 3: 优先级排序和根本原因
    - success_profile_report: 样本量信息
    - audit_report: owned_note_id

    任务：
    1. 整合所有分析结果到GapReport模型
    2. 确保所有字段符合Pydantic schema验证
    3. 添加metadata: keyword, owned_note_id, sample_size, gap_timestamp
    4. 输出为JSON格式

    输出格式必须严格遵循GapReport Pydantic模型。

    **输出格式要求（严格执行）**:
    - 只输出 JSON，不要有任何额外文字或解释
    - 不要使用 markdown 代码块
    - JSON 必须完整且格式正确，不能有语法错误
    - 不要在最后一个字段后添加逗号 (trailing comma)
    - 所有字符串必须正确转义（如引号、换行符）
  expected_output: |
    GapReport JSON，必须包含以下字段：

    顶层字段：
    - keyword: str - 目标关键词
    - owned_note_id: str - 自有笔记ID
    - significant_gaps: List[MetricGap] - 显著差距 (p < 0.05)
    - marginal_gaps: List[MetricGap] - 边缘显著差距 (0.05 <= p < 0.10)
    - non_significant_gaps: List[MetricGap] - 非显著差距
    - top_priority_metrics: List[str] - 最多3个重点指标
    - root_causes: List[str] - 3-5个根本原因
    - impact_summary: str - 整体影响总结 (50-500字符)
    - sample_size: int - 竞品笔记样本量
    - gap_timestamp: str - ISO 8601时间戳

    每个MetricGap对象必须包含：
    - metric_name: str - 指标名称
    - owned_value: float - 客户笔记的值
    - target_mean: float - 目标笔记均值
    - target_std: float - 目标笔记标准差
    - delta_absolute: float - 绝对差值
    - delta_pct: float - 百分比差值
    - z_score: float - Z分数
    - p_value: float - P值 (0.0-1.0)
    - significance: str - 显著性级别
    - interpretation: str - 人类可读的解释
    - priority_rank: int - 优先级排名 (1-based)
    - related_features: List[str] - 影响该指标的相关特征
    - rationale: str - 特征归因理由
    - missing_features: List[str] - 缺失的关键特征
    - weak_features: List[str] - 执行不足的特征
    - gap_explanation: str - 差距原因解释 (50-200字符)
    - recommendation_summary: str - 改进建议 (20-100字符)

    字段约束：
    - top_priority_metrics: 最多3个
    - root_causes: 3-5个
    - impact_summary: 50-500字符
    - gap_explanation: 50-200字符
    - recommendation_summary: 20-100字符
  agent: gap_finder
  context: [calculate_statistical_gaps, map_gaps_to_features, prioritize_gaps]
  output_file: outputs/gap_report.json
