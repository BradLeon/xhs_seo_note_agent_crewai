# Task Configuration for Owned Note Auditor Crew
# 自营笔记审计员 Crew 的任务配置
#
# 4 sequential tasks: extract features → analyze metrics → identify weaknesses → generate report

extract_content_features:
  description: |
    **任务目标**: 提取自营笔记的文本和视觉特征

    分析笔记ID: {note_id}，关键词: {keyword}

    **执行步骤**:
    1. 调用 nlp_text_analysis(note_id="{note_id}")
       - ⚠️ 重要: 只传 note_id 参数，工具会自动获取该笔记的文本内容并分析
       - 返回 TextAnalysisResult (30+ 个文本特征)
       - 包含: title_pattern, opening_strategy, content_framework, pain_points, value_propositions等

    2. 调用 multimodal_vision_analysis(note_id="{note_id}")
       - ⚠️ 重要: 只传 note_id 参数，工具会自动获取该笔记的图片并分析
       - 返回 VisionAnalysisResult (17+ 个视觉特征)
       - 包含: thumbnail_appeal, color_scheme, visual_tone, layout_style等

    3. 记录两个工具的完整JSON输出，供后续任务使用

    **禁止事项**:
    - ❌ 不要创造或想象笔记内容
    - ❌ 不要传递 note_metadata 参数（工具会自动获取）
    - ✅ 只使用真实的笔记ID: {note_id}
    - ✅ 让工具自动处理数据获取

  expected_output: "Combined text and visual features (TextAnalysisResult + VisionAnalysisResult JSON)"
  agent: owned_note_auditor


analyze_metric_performance:
  description: |
    **任务目标**: 分析10个预测指标的表现，识别弱项和强项

    基于上游任务提取的特征，以及笔记的 prediction 数据，分析以下10个指标:
    1. ctr (点击率)
    2. comment_rate (评论率)
    3. interaction_rate (互动率)
    4. sort_score2 (排序分数)
    5. like_rate (点赞率)
    6. share_rate (分享率)
    7. follow_rate (关注率)
    8. collect_rate (收藏率) - 即 fav_rate
    9. ces_rate (综合互动率)
    10. impression (曝光量)

    **执行步骤**:
    1. 读取笔记 {note_id} 的所有预测指标值 (从 shared context 的 owned_note_data.prediction)

    2. 对每个指标，根据以下阈值判断表现:
       - ctr: 弱 <0.05, 强 >0.10
       - comment_rate: 弱 <0.001, 强 >0.003
       - sort_score2: 弱 <0.35, 强 >0.50
       - interaction_rate: 弱 <0.02, 强 >0.05
       - like_rate: 弱 <0.03, 强 >0.06
       - share_rate: 弱 <0.005, 强 >0.015
       - follow_rate: 弱 <0.01, 强 >0.03
       - collect_rate: 弱 <0.01, 强 >0.03
       - ces_rate: 弱 <0.04, 强 >0.10
       - impression: 弱 <500, 强 >2000

    3. 生成两个列表:
       - weak_metrics: 表现不佳的指标名称列表 (e.g., ["ctr", "sort_score2"])
       - strong_metrics: 表现优秀的指标名称列表 (e.g., ["comment_rate"])

    **重要**: 必须分析全部10个指标。

  expected_output: "Metric performance analysis (weak_metrics list and strong_metrics list)"
  agent: owned_note_auditor


identify_weaknesses:
  description: |
    **任务目标**: 识别内容弱点和优势

    基于上游任务的结果:
    - text_features (TextAnalysisResult from Task 1)
    - visual_features (VisionAnalysisResult from Task 1)
    - weak_metrics (from Task 2)
    - strong_metrics (from Task 2)

    **执行步骤**:

    1. **分析内容弱点** (content_weaknesses):
       对比提取的特征与最佳实践，找出问题:

       a. 标题弱点 (如果 ctr 在 weak_metrics 中):
          - 检查 title_pattern: 是否有吸引力?
          - 检查 title_emotion: 情感是否到位?
          - 检查 title_keywords: 关键词是否突出?

       b. 开头弱点 (如果 ctr 或 interaction_rate 在 weak_metrics 中):
          - 检查 opening_hook: 钩子是否强力?
          - 检查 opening_impact: 冲击力是否足够?

       c. 正文弱点 (如果 comment_rate, interaction_rate 在 weak_metrics 中):
          - 检查 pain_points: 痛点挖掘是否到位?
          - 检查 value_propositions: 价值主张是否清晰?
          - 检查 content_framework: 框架是否完整?

       d. 视觉弱点 (如果 ctr 在 weak_metrics 中):
          - 检查 thumbnail_appeal: 封面吸引力如何?
          - 检查 color_scheme: 色彩方案是否合适?
          - 检查 visual_tone: 视觉调性是否统一?

       生成具体、可操作的弱点描述 (中文)，例如:
       - "标题缺乏情感钩子，未能激发用户点击欲望"
       - "封面视觉吸引力不足，色彩方案单调"
       - "正文缺乏痛点挖掘，价值主张不够清晰"

    2. **分析内容优势** (content_strengths):
       识别已有的强项特征:

       a. 如果某些 strong_metrics 存在，找出对应的优秀特征:
          - comment_rate 高 → 检查 pain_points, credibility_signals, emotional_triggers
          - ctr 高 → 检查 title_pattern, thumbnail_appeal
          - interaction_rate 高 → 检查 opening_hook, ending_cta

       b. 生成具体的优势描述 (中文)，例如:
          - "标题采用疑问句式，情感诉求强烈"
          - "正文痛点挖掘深刻，credibility信号明确"
          - "视觉叙事连贯，真实感和情绪基调把握准确"

    **重要**:
    - content_weaknesses 不能为空（每个笔记都有改进空间）
    - 每个弱点/优势描述应具体、可操作，避免泛泛而谈
    - 弱点应与 weak_metrics 有明确的因果关联

  expected_output: "Content analysis (content_weaknesses list and content_strengths list)"
  agent: owned_note_auditor


generate_audit_report:
  description: |
    **任务目标**: 生成最终的自营笔记审计报告

    基于上游所有任务的结果，创建完整的 AuditReport。

    **执行步骤**:

    1. 收集基础信息:
       - note_id: {note_id}
       - keyword: {keyword}
       - current_metrics: 所有10个预测指标的值 (从 shared context)

    2. 收集分析结果:
       - text_features: TextAnalysisResult (from Task 1)
       - visual_features: VisionAnalysisResult (from Task 1)
       - weak_metrics: List[str] (from Task 2)
       - strong_metrics: List[str] (from Task 2)
       - content_weaknesses: List[str] (from Task 3)
       - content_strengths: List[str] (from Task 3)

    3. 生成整体诊断 (overall_diagnosis):
       - 简洁总结核心问题 (50-200个字符)
       - 必须提及最关键的弱项指标和内容弱点
       - 用中文表达，例如:
         "CTR和sort_score2表现不佳,主要问题在于标题缺乏情感钩子,封面视觉吸引力不足,建议优化标题套路和封面设计。"

    4. 添加时间戳:
       - audit_timestamp: 当前时间 (ISO 8601 格式, e.g., "2025-11-19T15:30:00Z")

    5. 创建完整的 AuditReport JSON，确保符合以下schema:
       ```
       {{
         "note_id": str,
         "keyword": str,
         "current_metrics": dict (10个指标),
         "text_features": TextAnalysisResult,
         "visual_features": VisionAnalysisResult,
         "weak_metrics": list,
         "strong_metrics": list,
         "content_weaknesses": list (不能为空),
         "content_strengths": list,
         "overall_diagnosis": str (50-200 chars),
         "audit_timestamp": str
       }}
       ```

    **验证要点**:
    - content_weaknesses 不能为空
    - overall_diagnosis 必须 50-200 字符
    - current_metrics 必须包含全部10个指标
    - 所有嵌套对象 (text_features, visual_features) 必须完整

  expected_output: "Complete AuditReport (JSON format conforming to AuditReport schema)"
  agent: owned_note_auditor
  output_file: "outputs/audit_report.json"
